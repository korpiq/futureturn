<html>
<head>
 <style>
    div.hex {
      position: absolute;
      border: 1px solid black;
      background-color: white;
      height: 2em;
      width: 2em;
      text-align: center;
    }
    #hexmap_display {
        position: fixed;
        right: 0;
        width: 70%;
        height: 100%;
    }
    input {
        width: 3em
    }
    #form_container {
        width: 15em;
        text-align: right;
    }
    #bags_container {
        background-color: lightgray;
    }
    #rules_frame {
        height: 0;
        width: 0;
    }
 </style>
 <script type="text/javascript" language="javascript" src="HexTile.js"></script>
 <script type="text/javascript" language="javascript" src="HexMap.js"></script>
 <script type="text/javascript" language="javascript" src="HexTilePile.js"></script>
 <script type="text/javascript" language="javascript" src="HexTileBag.js"></script>
 <script type="text/javascript" language="javascript" src="rules.js"></script>
 <script language="javascript">
    var
      hexmap,
      tilebags,
      currentHexTileBag,
      hexesPerType,
      rules
      ;

    function drawMapFromInput()
    {
      if(! hexmap)
          hexmap = new HexMap({
              displayContainer: document.getElementById("hexmap_display")
          });

      var sides = getIntInput("sides");
      var equator = getIntInput("equator");

      hexmap.setSizes(equator, sides, sides);
      hexmap.draw();

      report();
      updateMixes();
    }

    function createTileBags()
    {
        var bagsContainer = document.getElementById('bags_container');

        if(tilebags && tilebags.length > 0)
        {
            for(var i=0; i < tilebags.length; ++i)
            {
                bagsContainer.removeChild(tilebags[i].element);
            }
        }
        tilebags = [];
        var count = parseInt(document.getElementById('types').value);

        for(var i=0; i < count; ++i)
        {
            var name = rules.tileTypes[i] ? rules.tileTypes[i].name : i;
            tilebags.push(new HexTileBag(name, i+1, count, hexesPerType, bagsContainer));
        }
        currentHexTileBag = tilebags[Math.floor(count/2 + 0.5)];
        currentHexTileBag.element.click();
        // decide starting type later currentHexTileBag.getTile().put(hexmap.getCenterHex());
        mixTilesBetweenBags();
    }

    function report()
    {
      hexes = hexmap.hexes.length;
      num_players = getIntInput("players");
      num_types = getIntInput("types");

      setText("hexes", hexes);
      setText("hexes_per_player", Math.floor(hexes / num_players));
      setText("hexes_per_type", hexesPerType = Math.ceil(hexes / num_types));
    }

    function setText(id, content)
    {
        document.getElementById(id).textContent = content;
    }

    function setPlayers(value)
    {
        var players = parseInt(value);
        setSides(6 + players);
    }

    function setSides(value)
    {
        setInput("sides", value);
        updateEquator();
    }
    function updateEquator()
    {
        var sideOddity = getIntInput("sides") % 2;
        var multiplier = getIntInput("equator_multiplier");
        setInput("equator", 2 + multiplier * sideOddity);

        drawMapFromInput();
    }
    function updateMixes()
    {
        setInput('rivers2terrain_bags', Math.round(hexesPerType / 5));
        setInput('tiles2neighbor_bags', Math.round(hexesPerType / 5));
        createTileBags();
    }
    function getIntInput(name)
    {
        return parseInt(document.getElementById(name).value);
    }
    function setInput(name, value)
    {
        document.getElementById(name).value = value;
    }
    function loadRules()
    {
        var client = new XMLHttpRequest();
        client.open('GET', 'rules.json');
        client.onreadystatechange = function () {
            rules = JSON.parse(client.responseText);
        };
        client.send();
    }
    function mixTilesBetweenBags()
    {
        var tilesForBags = getListOfEmptyPilesForEachTilebag();
        mixNonRiverTilesToNeighborBags(tilesForBags);
        mixRiverTilesToTerrainBags(tilesForBags);
        addSeaTilesToRiverBag(tilesForBags);
        putTilesFromPilesToBags(tilesForBags);
    }
    function mixRiverTilesToTerrainBags(tilesForBags)
    {
        var riverTilebagId = getIntInput('river_id') - 1;
        for(var i = riverTilebagId + 1; i < tilebags.length; ++i)
        {
            var countToMove = getIntInput('rivers2terrain_bags');
            while(countToMove--)
                tilebags[riverTilebagId].getTile().put(tilesForBags[i]);
        }
    }
    function mixNonRiverTilesToNeighborBags(tilesForBags)
    {
        // FIXME: move from sea to river but from lowlands to sea?
        // FIXME: do not move from sea to mountain?
        for(var i = 0; i < tilebags.length; i = next)
        {
            var next = i + (isRiver(i+1) ? 2 : 1);
            var countToMove = getIntInput('tiles2neighbor_bags');
            var target = next % tilebags.length;
            while(countToMove--)
            {
                // from current bag to next
                tilebags[i].getTile().put(tilesForBags[target]);
                // from next bag to current
                tilebags[target].getTile().put(tilesForBags[i]);
            }
        }
    }
    function addSeaTilesToRiverBag(tilesForBags)
    {
        var riverTilebagId = getIntInput('river_id') - 1;
        var countToMove = getIntInput('tiles2neighbor_bags');
        while(countToMove--)
        {
            tilebags[0].getTile().put(tilesForBags[riverTilebagId]);
        }
    }
    function isRiver(bagNumber)
    {
        return bagNumber == getIntInput('river_id') - 1;
    }
    function putTilesFromPilesToBags(tilesForBags)
    {
        for(var i = 0; i < tilesForBags.length; ++i)
        {
            tilesForBags[i].putAll(tilebags[i]);
        }
    }
    function getListOfEmptyPilesForEachTilebag()
    {
        var piles = [];
        while(piles.length < tilebags.length)
        {
            piles.push(new HexTilePile(tilebags[piles.length].name));
        }
        return piles;
    }
 </script>
</head>
<body onload="setPlayers(document.getElementById('players').value)">

 <div id="hexmap_display">&nbsp;</div>

 <div id="form_container">
 <form id="hexmap_settings" onsubmit="drawMapFromInput(); return false;">
  tile types: <input id="types" value="6" onchange="drawMapFromInput()"><br/>
  players: <input id="players" value="3" onchange="setPlayers(this.value)"><br/>
  <hr/>
  edge lengths:<br/>
  sides: <input id="sides" value="9" onchange="setSides(this.value)"><br/>
  equator: <input id="equator" value="1" onchange="drawMapFromInput()"><br/>
  equator range:
  <select id="equator_multiplier" onchange="setSides(document.getElementById('sides').value)">
      <option value="-1">1-2</option>
      <option value="0" selected>2</option>
      <option value="1">2-3</option>
  </select><br/>
  <hr/>
  river bag number: <input id="river_id" value="2" onchange="createTileBags()" /><br/>
  rivers to terrain bags: <input id="rivers2terrain_bags" value="3" onchange="createTileBags()" /><br/>
  others to neighbor bags: <input id="tiles2neighbor_bags" value="3" onchange="createTileBags()" /><br/>
  hexes: <span id="hexes"></span><br/>
  per player: <span id="hexes_per_player"></span><br/>
  per type: <span id="hexes_per_type"></span><br/>
 </form>
 </div>

 <div id="bags_container">
 </div>
</body>
</html>
